<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#031b26">
  <link rel="shortcut icon" type="image/ico" href="https://wp-assets.highcharts.com/www-highcharts-com/blog/wp-content/uploads/2021/05/19085042/favicon-1.ico"/>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highstock/6.0.3/highstock.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highstock/6.0.3/modules/exporting.js"></script>

  <style>
    body {
        background-color: #000000;
        color: white;
        height: 100%;
        margin: 0;
    }
    html {
      height: 100%;
      margin: 0;
    }
    #chart-container {
        height: calc(100% - 50px);
        box-sizing: border-box;
    }
    #controls {
      padding: 10px;
      text-align: center;
      background-color: #1a1a1a;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    #buttonSSS, #buttonLoad, .buttt, #Loads, #toggleCumulative {
      background-color:#004b5ef8;
      border-radius:6px;
      padding:8px 16px;
      color:#ffffff;
      border:0px;
      outline: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    #buttonSSS:hover, #buttonLoad:hover, #toggleCumulative:hover {
      background-color:#0081a1f8;
    }
    #buttonSSS:active, #buttonLoad:active, #toggleCumulative:active {
      box-shadow: 0 1px #666;
      transform: translateY(1px);
    }
    #buttonLoad {
      background-color:#691335;
    }
    #buttonLoad:hover {
      background-color:#c20f42;
    }
    #buttonLoad:active {
      background-color: #870117;
    }
  </style>
  
  <script>
    Highcharts.setOptions({
      colors: ['#ff0000', '#FFFF33', '#5f81e8', '#ff0066', '#e4d354', '#2b908f', '#f45b5b', '#91e8e1'],
      chart: {
        backgroundColor: {
          linearGradient: [0, 0, 500, 500],
          stops: [
            [0, 'rgb(000, 000, 000)'],
            [1, 'rgb(000, 000, 000)']
          ]
        },
        polar: true,
        type: 'area',
      },
      yAxis: {
        title: {
          style: {
            color: '#bfbfbf',
          }
        },
        gridLineColor: '#333333',
        labels: {
          style: {
            color: '#bfbfbf'
          }
        },
      },
      legend: {
        itemStyle: {
          color: '#bfbfbf',
          fontWeight: 'bold'
        },
        itemHoverStyle: {
          color: '#33cccc'
        },
        itemHiddenStyle: {
          color: 'gray'
        },
      },
      xAxis: {
        title: {
          style: {
            color: '#bfbfbf',
          }
        },
        labels: {
          style: {
            color: '#bfbfbf'
          }
        }
      },
      rangeSelector: {
        buttonTheme: {
          states: {
            hover: {},
            select: {
              fill: '#33cccc',
              style: {
                color: 'black'
              }
            }
          },
          style: {
            fontWeight: 'bold'
          }
        },
        inputStyle: {
          color: '#bfbfbf',
          fontWeight: 'bold'
        },
        labelStyle: {
          color: '#bfbfbf',
          fontWeight: 'bold'
        },
      }
    });

    var dynamicChart;
    var channelsLoaded = 0;
    var isCumulative = true;
    var rawData = {}; // Store raw data for recalculation
    var allSeries = [];
    
    var axesOrder = [
      { id: 'µg/m³', title: 'PM1' },
      { id: 'µg/m³', title: 'PM2.5' },
      { id: 'µg/m³', title: 'PM10' },
      { id: 'µm', title: 'Typical Particle Size' }
    ];

    var channelKeys = [
      { channelNumber: 2810907, name: 'PM1', key: '9CO03SP4XHCAR6X8', fieldList: [{ field: 5, axis: 'µg/m³', decimals: 2, threshold: null, enabled_by_default: true }] },
      { channelNumber: 2810907, name: 'PM2.5', key: '9CO03SP4XHCAR6X8', fieldList: [{ field: 6, axis: 'µg/m³', decimals: 2, threshold: null, enabled_by_default: true }] },
      { channelNumber: 2810907, name: 'PM10', key: '9CO03SP4XHCAR6X8', fieldList: [{ field: 7, axis: 'µg/m³', decimals: 2, threshold: null, enabled_by_default: true }] },
      { channelNumber: 2810907, name: 'Typical Particle Size', key: '9CO03SP4XHCAR6X8', fieldList: [{ field: 8, axis: 'µm', decimals: 2, threshold: null, enabled_by_default: false }] }
    ];

    var myOffset = new Date().getTimezoneOffset();

    function getChartDate(d) {
      return Date.UTC(d.substring(0, 4), d.substring(5, 7) - 1, d.substring(8, 10), d.substring(11, 13), d.substring(14, 16), d.substring(17, 19)) - (myOffset * 60000);
    }

    function calculateAndAddSeries() {
      allSeries = [];
      
      if (isCumulative) {
        // Use raw data as-is
        for (var fieldId in rawData) {
          var field = rawData[fieldId];
          allSeries.push({
            id: parseInt(fieldId),
            name: field.name,
            data: field.data,
            yAxis: field.axis,
            tooltip: {
              valueDecimals: field.decimals
            },
            threshold: field.threshold,
            visible: field.enabled_by_default
          });
        }
      } else {
        // Calculate non-cumulative values
        var pm1Data = rawData[5] ? rawData[5].data : [];
        var pm25Data = rawData[6] ? rawData[6].data : [];
        var pm10Data = rawData[7] ? rawData[7].data : [];
        
        // PM1 stays the same (smallest particles)
        if (rawData[5]) {
          allSeries.push({
            id: 5,
            name: rawData[5].name + ' (0-1µm)',
            data: pm1Data,
            yAxis: rawData[5].axis,
            tooltip: { valueDecimals: rawData[5].decimals },
            threshold: rawData[5].threshold,
            visible: rawData[5].enabled_by_default
          });
        }
        
        // PM2.5 non-cumulative = PM2.5 - PM1 (particles 1-2.5µm)
        if (rawData[6]) {
          var pm25NonCum = pm25Data.map(function(point, i) {
            var pm1Value = pm1Data[i] ? pm1Data[i][1] : 0;
            return [point[0], Math.max(0, point[1] - pm1Value)];
          });
          allSeries.push({
            id: 6,
            name: rawData[6].name + ' (1-2.5µm)',
            data: pm25NonCum,
            yAxis: rawData[6].axis,
            tooltip: { valueDecimals: rawData[6].decimals },
            threshold: rawData[6].threshold,
            visible: rawData[6].enabled_by_default
          });
        }
        
        // PM10 non-cumulative = PM10 - PM2.5 (particles 2.5-10µm)
        if (rawData[7]) {
          var pm10NonCum = pm10Data.map(function(point, i) {
            var pm25Value = pm25Data[i] ? pm25Data[i][1] : 0;
            return [point[0], Math.max(0, point[1] - pm25Value)];
          });
          allSeries.push({
            id: 7,
            name: rawData[7].name + ' (2.5-10µm)',
            data: pm10NonCum,
            yAxis: rawData[7].axis,
            tooltip: { valueDecimals: rawData[7].decimals },
            threshold: rawData[7].threshold,
            visible: rawData[7].enabled_by_default
          });
        }
        
        // Typical particle size stays the same
        if (rawData[8]) {
          allSeries.push({
            id: 8,
            name: rawData[8].name,
            data: rawData[8].data,
            yAxis: rawData[8].axis,
            tooltip: { valueDecimals: rawData[8].decimals },
            threshold: rawData[8].threshold,
            visible: rawData[8].enabled_by_default
          });
        }
      }
    }
    
    function toggleCumulativeView() {
      if (!dynamicChart || Object.keys(rawData).length === 0) {
        console.log('Chart or data not ready');
        return;
      }
      
      isCumulative = !isCumulative;
      
      // Update button text
      document.getElementById('toggleCumulative').textContent = 
        isCumulative ? 'Switch to Non-Cumulative' : 'Switch to Cumulative';
      
      // Recalculate series data
      calculateAndAddSeries();
      
      // Update each series with new data
      allSeries.forEach(function(newSeriesData) {
        var existingSeries = null;
        
        // Find existing series with matching ID
        for (var i = 0; i < dynamicChart.series.length; i++) {
          if (dynamicChart.series[i].userOptions.id === newSeriesData.id) {
            existingSeries = dynamicChart.series[i];
            break;
          }
        }
        
        if (existingSeries) {
          // Update existing series
          existingSeries.update({
            name: newSeriesData.name,
            data: newSeriesData.data
          }, false);
        }
      });
      
      dynamicChart.redraw();
    }

    $(document).ready(function () {
      dynamicChart = new Highcharts.stockChart('chart-container', {
        chart: {
          events: {
            load: function () {
              setInterval(updateChart, 60000); // Update chart every minute
            }
          }
        },
        rangeSelector: {
          buttons: [
            { count: 1, type: 'hour', text: '1H' },
            { count: 3, type: 'hour', text: '3H' },
            { count: 6, type: 'hour', text: '6H' },
            { count: 12, type: 'hour', text: '12H' },
            { count: 1, type: 'day', text: 'D' },
            { count: 3, type: 'day', text: '3D' },
            { count: 1, type: 'week', text: 'W' },
            { count: 1, type: 'month', text: 'M' },
            { count: 6, type: 'month', text: '6M' },
            { count: 1, type: 'year', text: 'Y' },
            { type: 'all', text: 'All' }
          ],
          inputEnabled: true,
          selected: 11
        },
        plotOptions: {
          series: {
            fillOpacity: 0.3,
            marker: { enabled: false }
          }
        },
        tooltip: {
          split: true,
        },
        xAxis: {
          type: 'datetime',
          ordinal: false
        },
        yAxis: axesOrder.map(function(axis, index) {
          return {
            id: axis.id,
            title: { 
              text: axis.title,
              style: {
                color: '#bfbfbf',
              }
            },
            opposite: false,
            lineWidth: 1,
            labels: {
              align: 'right',
              x: -4,
              y: 4,
              style: {
                color: '#bfbfbf'
              }
            },
            gridLineColor: '#333333',
            showEmpty: false,
          };
        }),
        legend: {
          enabled: true
        },
        exporting: { enabled: false },
        navigator: { enabled: false },
        loading: {
          labelStyle: {
            color: 'white',
            fontSize: '26px'
          },
          style: {
            backgroundColor: 'rgba(0, 0, 0, 0.75)'
          },
          label: 'Loading data, please wait...'
        }
      });

      dynamicChart.showLoading();

      var last_date;
      var allSeries = [];  // Changed to array instead of object

      function loadThingSpeakChannel(channelNumber, key) {
        return $.getJSON(`https://api.thingspeak.com/channels/${channelNumber}/feeds.json?results=8000&api_key=${key}`)
          .then(function (data) {
            // Store raw data for each field
            channelKeys.forEach(function (channel) {
              channel.fieldList.forEach(function (field) {
                var fieldData = [];
                for (var h = 0; h < data.feeds.length; h++) {
                  var v = data.feeds[h]["field" + field.field];
                  if (v != null) {
                    var p = [getChartDate(data.feeds[h].created_at), parseFloat(v)];
                    fieldData.push(p);
                  }
                }
                rawData[field.field] = {
                  name: data.channel["field" + field.field],
                  data: fieldData,
                  axis: field.axis,
                  decimals: field.decimals,
                  threshold: field.threshold,
                  enabled_by_default: field.enabled_by_default
                };
              });
            });
            
            // Calculate and add series
            calculateAndAddSeries();
          });
      }
      
      function calculateAndAddSeries() {
        allSeries = [];
        
        if (isCumulative) {
          // Use raw data as-is
          for (var fieldId in rawData) {
            var field = rawData[fieldId];
            allSeries.push({
              id: parseInt(fieldId),
              name: field.name,
              data: field.data,
              yAxis: field.axis,
              tooltip: {
                valueDecimals: field.decimals
              },
              threshold: field.threshold,
              visible: field.enabled_by_default
            });
          }
        } else {
          // Calculate non-cumulative values
          var pm1Data = rawData[5] ? rawData[5].data : [];
          var pm25Data = rawData[6] ? rawData[6].data : [];
          var pm10Data = rawData[7] ? rawData[7].data : [];
          
          // PM1 stays the same (smallest particles)
          if (rawData[5]) {
            allSeries.push({
              id: 5,
              name: rawData[5].name + ' (0-1µm)',
              data: pm1Data,
              yAxis: rawData[5].axis,
              tooltip: { valueDecimals: rawData[5].decimals },
              threshold: rawData[5].threshold,
              visible: rawData[5].enabled_by_default
            });
          }
          
          // PM2.5 non-cumulative = PM2.5 - PM1 (particles 1-2.5µm)
          if (rawData[6]) {
            var pm25NonCum = pm25Data.map(function(point, i) {
              var pm1Value = pm1Data[i] ? pm1Data[i][1] : 0;
              return [point[0], Math.max(0, point[1] - pm1Value)];
            });
            allSeries.push({
              id: 6,
              name: rawData[6].name + ' (1-2.5µm)',
              data: pm25NonCum,
              yAxis: rawData[6].axis,
              tooltip: { valueDecimals: rawData[6].decimals },
              threshold: rawData[6].threshold,
              visible: rawData[6].enabled_by_default
            });
          }
          
          // PM10 non-cumulative = PM10 - PM2.5 (particles 2.5-10µm)
          if (rawData[7]) {
            var pm10NonCum = pm10Data.map(function(point, i) {
              var pm25Value = pm25Data[i] ? pm25Data[i][1] : 0;
              return [point[0], Math.max(0, point[1] - pm25Value)];
            });
            allSeries.push({
              id: 7,
              name: rawData[7].name + ' (2.5-10µm)',
              data: pm10NonCum,
              yAxis: rawData[7].axis,
              tooltip: { valueDecimals: rawData[7].decimals },
              threshold: rawData[7].threshold,
              visible: rawData[7].enabled_by_default
            });
          }
          
          // Typical particle size stays the same
          if (rawData[8]) {
            allSeries.push({
              id: 8,
              name: rawData[8].name,
              data: rawData[8].data,
              yAxis: rawData[8].axis,
              tooltip: { valueDecimals: rawData[8].decimals },
              threshold: rawData[8].threshold,
              visible: rawData[8].enabled_by_default
            });
          }
        }
      }
      
      function toggleCumulativeView() {
        isCumulative = !isCumulative;
        
        // Update button text
        document.getElementById('toggleCumulative').textContent = 
          isCumulative ? 'Switch to Non-Cumulative' : 'Switch to Cumulative';
        
        // Remove all series
        while(dynamicChart.series.length > 0) {
          dynamicChart.series[0].remove(false);
        }
        
        // Recalculate and add series
        calculateAndAddSeries();
        allSeries.forEach(function(series) {
          dynamicChart.addSeries(series, false);
        });
        
        dynamicChart.redraw();
      }

      loadThingSpeakChannel(channelKeys[0].channelNumber, channelKeys[0].key)
        .then(function () {
          // Add all series from the array
          allSeries.forEach(function(series) {
            dynamicChart.addSeries(series, false);
          });
          dynamicChart.redraw();
          dynamicChart.hideLoading();
        })
        .catch(function (error) {
          console.error("Error loading data:", error);
        });

      function updateChart() {
        var channelNumber = channelKeys[0].channelNumber;
        var key = channelKeys[0].key;
        
        $.getJSON(`https://api.thingspeak.com/channels/${channelNumber}/feed/last.json?api_key=${key}`)
          .done(function (data) {
            var series = dynamicChart.series;
            var pointTime = getChartDate(data.created_at);
            
            // Get raw values
            var pm1Val = data['field5'] ? parseFloat(data['field5']) : 0;
            var pm25Val = data['field6'] ? parseFloat(data['field6']) : 0;
            var pm10Val = data['field7'] ? parseFloat(data['field7']) : 0;
            var typicalSize = data['field8'] ? parseFloat(data['field8']) : null;
            
            // Calculate values based on mode
            var values = {};
            if (isCumulative) {
              values[5] = pm1Val;
              values[6] = pm25Val;
              values[7] = pm10Val;
              values[8] = typicalSize;
            } else {
              // Non-cumulative: subtract lower ranges
              values[5] = pm1Val; // PM1 stays the same (0-1µm)
              values[6] = Math.max(0, pm25Val - pm1Val); // PM2.5 - PM1 (1-2.5µm)
              values[7] = Math.max(0, pm10Val - pm25Val); // PM10 - PM2.5 (2.5-10µm)
              values[8] = typicalSize; // Typical size stays the same
            }
            
            series.forEach(function (s) {
              if (s.userOptions.id && values[s.userOptions.id] !== null && values[s.userOptions.id] !== undefined) {
                var newPoint = [pointTime, values[s.userOptions.id]];
                s.addPoint(newPoint, true, true);
              }
            });
          })
          .fail(function (error) {
            console.error("Error updating data:", error);
          });
      }
    });
  </script>
  <title>SmartHome | PM DATA</title>
</head>
<body>
  <div id="chart-container"></div>
  <div id="controls">
    <button id="toggleCumulative" onclick="toggleCumulativeView()">Switch to Non-Cumulative</button>
  </div>
</body>
</html>